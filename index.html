<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>MOG - Portfolio</title>

<!-- GSAP from cdnjs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

<style>
/* ========================================================================
   CSS VARIABLES
   ======================================================================== */
:root {
  --z-background: 0;
  --z-content: 1;
  --z-icons: 2;
  --z-transition: 999;
  --z-loading: 9999;

  --color-bg: black;
  --color-text: white;
  --color-accent: #333;

  --transition-fast: 0.1s;
  --transition-normal: 0.3s;

  --space-sm: 1rem;
  --space-md: 2rem;
  --space-lg: 3rem;
}

/* ========================================================================
   BASE
   ======================================================================== */
html, body {
  margin: 0;
  width: 100%;
  height: 100%;
  background: var(--color-bg);
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  overscroll-behavior: none;
  -webkit-overflow-scrolling: touch;
}

/* ========================================================================
   LOADING SCREEN
   ======================================================================== */
#loadingScreen {
  position: fixed;
  inset: 0;
  background: var(--color-bg);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: var(--z-loading);
  color: var(--color-text);
  font-family: Arial, sans-serif;
}
#loadingScreen h2 { font-size: 2rem; margin-bottom: var(--space-sm); }
#loadingProgress { font-size: 1.2rem; opacity: 0.7; }

/* ========================================================================
   CONTAINER  ‚Äî opacity animated by GSAP on load, no CSS transition needed
   ======================================================================== */
#container {
  position: relative;
  width: 100vw;
  height: 100vh;
  max-width: calc(100vh * 16 / 9);
  max-height: calc(100vw * 9 / 16);
  background: var(--color-bg);
  opacity: 0;
  -webkit-tap-highlight-color: transparent;
  touch-action: none;
}

/* ========================================================================
   BACKGROUND VIDEO & FREEZE
   ======================================================================== */
#bgVideo, #bgFreeze {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
  z-index: var(--z-background);
}
#bgFreeze { display: none; }

/* ========================================================================
   CONTENT LAYERS
   ======================================================================== */
#mainContent {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  z-index: var(--z-content);
}

/* Pages ‚Äî opacity / children animated entirely by GSAP */
#contactsPage, #eduPage {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  background: var(--color-bg);
  color: var(--color-text);
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: var(--z-content);
  font-family: Arial, sans-serif;
}

/* ========================================================================
   TRANSITION VIDEO
   ======================================================================== */
#transitionVideo {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
  z-index: var(--z-transition);
  display: none;
  pointer-events: none;
}
/* Edu: video behind icons so their fade is visible */
#transitionVideo.under-icons { z-index: 0; }

/* ========================================================================
   SVG / EYE  ‚Äî opacity managed by GSAP
   ======================================================================== */
svg {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  z-index: var(--z-content);
  will-change: transform;
  transform: translateZ(0);
}
#eyeOffset { opacity: 0; }   /* GSAP sets this */

#blinkLid {
  transform-origin: 50% 50%;
  transform: scaleY(0);
  pointer-events: none;
}
#reflections { mix-blend-mode: screen; }

@keyframes blink {
  0%   { transform: scaleY(0) translateY(-50%); }
  45%  { transform: scaleY(1) translateY(0%); }
  55%  { transform: scaleY(1) translateY(0%); }
  100% { transform: scaleY(0) translateY(-50%); }
}

/* ========================================================================
   SPRITE SHEET ICONS
   ======================================================================== */
.icon {
  position: absolute;
  transform-origin: center center;
  z-index: var(--z-icons);
  pointer-events: auto;
  cursor: pointer;
  filter: drop-shadow(0 0 0px rgba(0,0,0,0));
  opacity: 1;
  transition: filter var(--transition-fast) ease;
  will-change: background-position, transform;
  transform: translateZ(0);
  backface-visibility: hidden;
  -webkit-tap-highlight-color: transparent;
  user-select: none;
  -webkit-user-select: none;
  background-repeat: no-repeat;
  image-rendering: -webkit-optimize-contrast;
  image-rendering: crisp-edges;
}

/* Flag class ‚Äî pointer-events only; GSAP handles the opacity */
.icon.icon-hidden { pointer-events: none; }
.icon.touching { filter: drop-shadow(0 0 10px rgba(255,255,255,0.5)); }

/* Individual icon sprite settings - base size 180px like original */
#icon-art {
  width: 180px;
  height: 169px; /* maintain aspect ratio: 180 * (425/453) */
  background-image: url('sprites/art_sprite.png');
  background-size: 8640px 169px; /* scale proportionally: 21744 * (180/453) */
  background-position: 0 0;
}

#icon-contacts {
  width: 180px;
  height: 203px; /* maintain aspect ratio: 180 * (436/386) */
  background-image: url('sprites/contacts_sprite.png');
  background-size: 5400px 203px; /* scale proportionally: 11580 * (180/386) */
  background-position: 0 0;
}

#icon-edu {
  width: 180px;
  height: 126px; /* maintain aspect ratio: 180 * (320/456) */
  background-image: url('sprites/edu_sprite.png');
  background-size: 9000px 126px; /* scale proportionally: 22800 * (180/456) */
  background-position: 0 0;
}

#icon-work {
  width: 180px;
  height: 226px; /* maintain aspect ratio: 180 * (397/316) */
  background-image: url('sprites/work_sprite.png');
  background-size: 5220px 226px; /* scale proportionally: 9164 * (180/316) */
  background-position: 0 0;
}

/* ========================================================================
   PAGE CONTENT STYLES
   ======================================================================== */
#contactsPage h1, #eduPage h1 {
  font-size: 4rem;
  margin-bottom: var(--space-md);
  text-transform: uppercase;
  letter-spacing: 0.5rem;
}
#contactsPage p, #eduPage p {
  font-size: 1.5rem;
  margin-bottom: var(--space-lg);
  opacity: 0.7;
}
.backButton {
  padding: var(--space-sm) var(--space-lg);
  font-size: 1.2rem;
  background: var(--color-text);
  color: var(--color-bg);
  border: none;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 0.2rem;
  transition: all var(--transition-normal) ease;
  -webkit-tap-highlight-color: transparent;
}
.backButton:hover { background: var(--color-accent); color: var(--color-text); transform: scale(1.05); }
.backButton:active { transform: scale(0.95); }

/* ========================================================================
   RESPONSIVE
   ======================================================================== */
@media (max-width: 768px) {
  #contactsPage h1, #eduPage h1 { font-size: 2.5rem; letter-spacing: 0.3rem; }
  #contactsPage p, #eduPage p   { font-size: 1.2rem; }
  .backButton { font-size: 1rem; padding: 0.8rem 2rem; }
}
</style>
</head>
<body>

<!-- Loading Screen -->
<div id="loadingScreen">
  <h2>Loading...</h2>
  <p id="loadingProgress">Preparing assets...</p>
</div>

<div id="container">
  <video id="bgVideo" autoplay muted playsinline webkit-playsinline>
    <source src="mog.webm" type="video/webm">
  </video>
  <canvas id="bgFreeze"></canvas>

  <!-- Home -->
  <div id="mainContent">
    <div class="icon" id="icon-art"      role="button" aria-label="Art Portfolio" tabindex="0"></div>
    <div class="icon" id="icon-edu"      role="button" aria-label="Education"     tabindex="0"></div>
    <div class="icon" id="icon-contacts" role="button" aria-label="Contacts"      tabindex="0"></div>
    <div class="icon" id="icon-work"     role="button" aria-label="Work"          tabindex="0"></div>

    <svg viewBox="0 0 1920 1080" aria-hidden="true">
      <defs>
        <mask id="eyeMask" maskUnits="userSpaceOnUse">
          <image href="mask.png" x="0" y="0" width="1920" height="1080" preserveAspectRatio="none"/>
        </mask>
      </defs>
      <g id="eyeContainer" transform="translate(960,535) scale(1) translate(-960,-540)">
        <g id="eyeOffset">
          <image href="White.png" x="0" y="0" width="1920" height="1080"/>
          <g mask="url(#eyeMask)">
            <g id="eyeMove">
              <image href="Iris.png" x="0" y="0" width="1920" height="1080"/>
            </g>
            <g id="reflectionsMove">
              <image id="reflections" href="reflections.png" x="-690" y="-487" width="3090" height="2390"/>
            </g>
            <rect id="blinkLid" x="0" y="0" width="1920" height="1080" fill="black"/>
          </g>
        </g>
      </g>
    </svg>
  </div>

  <!-- Contacts Page -->
  <div id="contactsPage">
    <h1>Contacts</h1>
    <p>This is the contacts page content.</p>
    <p>You can add your contact information here!</p>
    <button class="backButton" id="backButtonContacts">‚Üê Back to Home</button>
  </div>

  <!-- Education Page -->
  <div id="eduPage">
    <h1>Education</h1>
    <p>This is the education page content.</p>
    <p>Coming soon!</p>
    <button class="backButton" id="backButtonEdu">‚Üê Back to Home</button>
  </div>

  <!-- Transition Video -->
  <video id="transitionVideo" muted playsinline webkit-playsinline>
    <source src="" type="video/webm">
  </video>
</div>

<script>
'use strict';

/* ========================================================================
   DEVICE DETECTION
   ======================================================================== */
const DeviceDetector = {
  isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
  isTouchDevice: 'ontouchstart' in window || navigator.maxTouchPoints > 0,
  init() {
    console.log('üì± Device type:', this.isMobile ? 'Mobile' : 'Desktop');
    console.log('üëÜ Touch support:', this.isTouchDevice ? 'Yes' : 'No');
  }
};

/* ========================================================================
   CONFIG
   ======================================================================== */
const CONFIG = {
  ASSETS: {
    CRITICAL: [
      'White.png','Iris.png','mask.png','reflections.png',
      'sprites/art_sprite.png','sprites/contacts_sprite.png',
      'sprites/edu_sprite.png','sprites/work_sprite.png'
    ]
  },

  TIMING: {
    CONTACTS_ICON_FADE:     2168,   // ms into contacts forward video ‚Üí icons start fading
    EDU_ICON_FADE:          1006,   // ms into edu forward video ‚Üí icons start fading
    EDU_REVERSE_ICON_FADE:  725,    // ms into edu reverse video ‚Üí icons fade back in
    BLINK_AFTER_TRANSITION: 150,
    EYE_ACTIVATE_TIME:      4.037,  // seconds into bgVideo
    LOADING_DELAY:          500,
    LOADING_TIMEOUT:        5000,   // Force load after 5 seconds
    BLINK_SPEED:            150,
    DOUBLE_BLINK_DELAY:     180,
    BLINK_MIN_DELAY:        2400,
    BLINK_MAX_DELAY:        5000,
    EYE_FALLBACK_TIMEOUT:   8000
  },

  LAYOUT: { DESIGN_WIDTH: 1920, DESIGN_HEIGHT: 1080 },

  ICON_SETTINGS: {
    "icon-art":      { x: 220,  y: 810, scale: 2.5  },
    "icon-edu":      { x: 230,  y: 225, scale: 2.5  },
    "icon-work":     { x: 1690, y: 235, scale: 1.77 },
    "icon-contacts": { x: 1685, y: 810, scale: 2.2 }
  },

  TRANSITION: {
    OFFSET: 1,
    CONTACTS_FORWARD: 'transition.webm',
    CONTACTS_REVERSE: 'reverse.webm',
    EDU_FORWARD:      'edu_transition.webm',
    EDU_REVERSE:      'edu_reverse.webm'
  },

  EYE: { DOUBLE_BLINK_CHANCE: 0.3, REFLECTION_MOVEMENT: 0.1 },

  // All GSAP durations live here (in seconds)
  GSAP: {
    CONTAINER_FADE:          0.5,
    ICON_FADE:               0.6,
    EYE_FADE_FAST:           0.15,   // eye ‚Üî transition video hand-off
    EYE_FADE_ACTIVATE:       0.3,    // very first eye appearance
    EYE_RESET_DURATION:      0.8,    // eye gliding back to center
    PAGE_CONTENT_DURATION:   0.4,    // each child fade
    PAGE_CONTENT_STAGGER:    0.13,   // delay between children
    PAGE_CONTENT_DELAY:      0.15    // initial delay before first child
  },

  DEBUG: false
};

/* ========================================================================
   UTILS
   ======================================================================== */
const Utils = {
  log: (...args) => { if (CONFIG.DEBUG) console.log(...args); },
  wait: (ms) => new Promise(r => setTimeout(r, ms)),
  getElement: (id) => {
    const el = document.getElementById(id);
    if (!el) console.error(`Element not found: ${id}`);
    return el;
  }
};

/* ========================================================================
   PRELOADER - FIXED VERSION
   ======================================================================== */
const Preloader = {
  loadedCount: 0,
  totalAssets: CONFIG.ASSETS.CRITICAL.length,
  forceLoadTriggered: false,

  init() {
    const loadingScreen = Utils.getElement('loadingScreen');
    const loadingProgress = Utils.getElement('loadingProgress');
    const container = Utils.getElement('container');

    // Preload only images (no videos in critical assets anymore)
    CONFIG.ASSETS.CRITICAL.forEach(src => {
      this.preloadImage(src);
    });

    this.updateProgress = () => {
      this.loadedCount++;
      const pct = Math.round((this.loadedCount / this.totalAssets) * 100);
      loadingProgress.textContent = `Loading assets... ${pct}%`;

      if (this.loadedCount === this.totalAssets && !this.forceLoadTriggered) {
        this.completeLoading(loadingScreen, container);
      }
    };

    // Force load after timeout
    setTimeout(() => {
      if (!this.forceLoadTriggered) {
        console.warn('‚ö†Ô∏è Loading timeout - forcing page load');
        this.forceLoadTriggered = true;
        this.completeLoading(loadingScreen, container);
      }
    }, CONFIG.TIMING.LOADING_TIMEOUT);
  },

  completeLoading(loadingScreen, container) {
    setTimeout(() => {
      loadingScreen.style.display = 'none';
      gsap.to(container, { opacity: 1, duration: CONFIG.GSAP.CONTAINER_FADE, ease: 'power2.out' });
    }, CONFIG.TIMING.LOADING_DELAY);
  },

  preloadImage(src) {
    const i = new Image();
    i.onload = () => this.updateProgress();
    i.onerror = () => {
      console.warn(`Failed to load: ${src}`);
      this.updateProgress(); // Still count it to avoid infinite loading
    };
    i.src = src;
  }
};

/* ========================================================================
   ICON POSITIONING
   ======================================================================== */
const IconPositioner = {
  positionIcons() {
    const container = Utils.getElement('container');
    const cw = container.offsetWidth, ch = container.offsetHeight;
    for (const id in CONFIG.ICON_SETTINGS) {
      const el = Utils.getElement(id);
      if (!el) continue;
      const s = CONFIG.ICON_SETTINGS[id];
      const scale = Math.min(cw / CONFIG.LAYOUT.DESIGN_WIDTH, ch / CONFIG.LAYOUT.DESIGN_HEIGHT);
      el.style.left = (s.x / CONFIG.LAYOUT.DESIGN_WIDTH) * 100 + '%';
      el.style.top  = (s.y / CONFIG.LAYOUT.DESIGN_HEIGHT) * 100 + '%';
      el.style.transform = `translate(-50%, -50%) scale(${s.scale * scale})`;
    }
  },
  init() {
    this.positionIcons();
    window.addEventListener('resize', () => this.positionIcons());
  }
};

/* ========================================================================
   SPRITE SHEET ICON - SIMPLIFIED VERSION
   ======================================================================== */
class SpriteSheetIcon {
  constructor(element, frameCount, frameWidth, frameHeight, spriteWidth, holdFrame = null, speeds = {}) {
    this.element = element;
    this.frameCount = frameCount;
    this.frameWidth = frameWidth;
    this.frameHeight = frameHeight;
    this.spriteWidth = spriteWidth;
    this.holdFrame = holdFrame;
    
    // Animation state
    this.currentFrame = 0;
    this.targetFrame = 0;
    this.isHovering = false;
    this.isHolding = false;
    this.isTouching = false;
    
    // SIMPLIFIED SPEEDS - just forward, reverse, loop
    this.forwardSpeed = speeds.forwardSpeed || 0.5;
    this.reverseSpeed = speeds.reverseSpeed || 0.3;
    this.loopSpeed = speeds.loopSpeed || 0.2;
    
    this.animationFrame = null;
    
    this.setupListeners();
    this.animate();
  }

  setupListeners() {
    this.element.addEventListener('mouseenter', () => {
      if (DeviceDetector.isTouchDevice) return;
      this.isHovering = true;
      this.element.style.filter = 'drop-shadow(0 0 10px rgba(0,0,0,1)) drop-shadow(0 0 18px rgba(0,0,0,1)) drop-shadow(0 0 28px rgba(0,0,0,1))';
      if (this.holdFrame !== null) {
        this.targetFrame = this.holdFrame;
      }
    });

    this.element.addEventListener('mouseleave', () => {
      if (DeviceDetector.isTouchDevice) return;
      this.isHovering = false;
      this.isHolding = false;
      this.targetFrame = 0;
      this.element.style.filter = 'drop-shadow(0 0 0px rgba(0,0,0,0))';
    });

    this.element.addEventListener('touchstart', (e) => {
      e.preventDefault();
      this.isTouching = this.isHovering = true;
      this.element.classList.add('touching');
      this.element.style.filter = 'drop-shadow(0 0 10px rgba(0,0,0,1)) drop-shadow(0 0 18px rgba(0,0,0,1)) drop-shadow(0 0 28px rgba(0,0,0,1))';
      if (this.holdFrame !== null) {
        this.targetFrame = this.holdFrame;
      }
    }, { passive: false });

    this.element.addEventListener('touchend', (e) => {
      e.preventDefault();
      this.element.click();
      this.isHovering = this.isHolding = this.isTouching = false;
      this.targetFrame = 0;
      this.element.style.filter = 'drop-shadow(0 0 0px rgba(0,0,0,0))';
      this.element.classList.remove('touching');
    }, { passive: false });

    this.element.addEventListener('touchcancel', () => {
      this.isHovering = this.isHolding = this.isTouching = false;
      this.targetFrame = 0;
      this.element.style.filter = 'drop-shadow(0 0 0px rgba(0,0,0,0))';
      this.element.classList.remove('touching');
    });
  }

  updateBackgroundPosition() {
    const frameIndex = Math.floor(this.currentFrame);
    const xPos = frameIndex * this.frameWidth;
    this.element.style.backgroundPosition = `-${xPos}px 0`;
  }

  animate() {
    if (this.isHovering) {
      // Forward animation
      if (this.holdFrame === null) {
        // Loop continuously (work icon)
        this.currentFrame += this.loopSpeed;
        if (this.currentFrame >= this.frameCount - 1) {
          this.currentFrame = 0;
        }
      } else {
        // Animate to hold frame (art, contacts, edu)
        if (!this.isHolding && Math.abs(this.currentFrame - this.holdFrame) < 0.5) {
          this.isHolding = true;
          this.currentFrame = this.holdFrame;
          this.targetFrame = this.holdFrame;
        }
        
        if (!this.isHolding) {
          const distance = Math.abs(this.targetFrame - this.currentFrame);
          const speed = distance < 2 ? 0.3 : this.forwardSpeed;
          this.currentFrame += (this.targetFrame - this.currentFrame) * speed;
          
          if (distance < 0.1) {
            this.currentFrame = this.targetFrame;
          }
        }
      }
    } else {
      // Reverse animation
      if (this.currentFrame > 0) {
        this.currentFrame -= this.reverseSpeed;
        if (this.currentFrame < 0) {
          this.currentFrame = 0;
        }
      }
    }

    this.updateBackgroundPosition();
    this.animationFrame = requestAnimationFrame(() => this.animate());
  }

  reset() {
    if (this.animationFrame) {
      cancelAnimationFrame(this.animationFrame);
      this.animationFrame = null;
    }
    this.isHovering = this.isHolding = this.isTouching = false;
    this.targetFrame = this.currentFrame = 0;
    this.element.style.filter = 'drop-shadow(0 0 0px rgba(0,0,0,0))';
    this.element.classList.remove('touching');
    this.updateBackgroundPosition();
    this.animate();
  }
}

/* ========================================================================
   TRANSITION MANAGER
   ======================================================================== */
const TransitionManager = {
  isTransitioning: false,
  transitionVideo: null,
  contactsPage: null,
  eduPage: null,
  mainContent: null,

  init() {
    this.transitionVideo = Utils.getElement('transitionVideo');
    this.contactsPage    = Utils.getElement('contactsPage');
    this.eduPage         = Utils.getElement('eduPage');
    this.mainContent     = Utils.getElement('mainContent');
    this.setupContactsTransition();
    this.setupEduTransition();
    this.setupReverseTransition(Utils.getElement('backButtonContacts'), 'contacts');
    this.setupReverseTransition(Utils.getElement('backButtonEdu'),      'edu');
  },

  async playTransitionVideo(path) {
    const v = this.transitionVideo, src = v.querySelector('source');
    v.style.transform = `translateY(${CONFIG.TRANSITION.OFFSET}px)`;
    src.src = path;
    v.load();
    v.style.display = 'block';
    v.currentTime = 0;
    return v.play();
  },

  waitForVideoEnd() {
    return new Promise(resolve => { this.transitionVideo.onended = resolve; });
  },

  fadeInPageContent(page) {
    const kids = Array.from(page.children);
    gsap.set(kids, { opacity: 0, y: 12 });
    gsap.to(kids, {
      opacity: 1, y: 0,
      duration: CONFIG.GSAP.PAGE_CONTENT_DURATION,
      stagger:  CONFIG.GSAP.PAGE_CONTENT_STAGGER,
      delay:    CONFIG.GSAP.PAGE_CONTENT_DELAY,
      ease:     'power2.out'
    });
  },

  fadeIconsOut() {
    const icons = document.querySelectorAll('.icon');
    icons.forEach(i => i.classList.add('icon-hidden'));
    gsap.to(icons, { opacity: 0, duration: CONFIG.GSAP.ICON_FADE, ease: 'power2.in' });
  },

  fadeIconsIn(delaySeconds = 0) {
    const icons = document.querySelectorAll('.icon');
    gsap.to(icons, {
      opacity: 1,
      duration: CONFIG.GSAP.ICON_FADE,
      delay:    delaySeconds,
      ease:     'power2.out',
      onStart:  () => icons.forEach(i => i.classList.remove('icon-hidden'))
    });
  },

  setupContactsTransition() {
    Utils.getElement('icon-contacts').addEventListener('click', async () => {
      if (this.isTransitioning) return;
      this.isTransitioning = true;
      try {
        EyeSystem.blinkOnce();
        await Utils.wait(CONFIG.TIMING.BLINK_AFTER_TRANSITION);
        await EyeSystem.resetToCenter();

        await this.playTransitionVideo(CONFIG.TRANSITION.CONTACTS_FORWARD);
        setTimeout(() => this.fadeIconsOut(), CONFIG.TIMING.CONTACTS_ICON_FADE);
        await this.waitForVideoEnd();

        this.mainContent.style.display      = 'none';
        this.transitionVideo.style.display  = 'none';
        this.contactsPage.style.display     = 'flex';
        Utils.getElement('bgFreeze').style.display = 'block';

        this.fadeInPageContent(this.contactsPage);
      } catch (e) {
        console.error('Contacts transition error:', e);
        this.handleTransitionError('contacts');
      } finally { this.isTransitioning = false; }
    });
  },

  setupEduTransition() {
    Utils.getElement('icon-edu').addEventListener('click', async () => {
      if (this.isTransitioning) return;
      this.isTransitioning = true;
      try {
        EyeSystem.blinkOnce();
        await Utils.wait(CONFIG.TIMING.BLINK_AFTER_TRANSITION);
        await EyeSystem.resetToCenter();

        Utils.getElement('bgFreeze').style.display = 'none';
        gsap.to(Utils.getElement('eyeOffset'), { opacity: 0, duration: CONFIG.GSAP.EYE_FADE_FAST, ease: 'power2.in' });

        this.transitionVideo.classList.add('under-icons');
        await this.playTransitionVideo(CONFIG.TRANSITION.EDU_FORWARD);
        setTimeout(() => this.fadeIconsOut(), CONFIG.TIMING.EDU_ICON_FADE);
        await this.waitForVideoEnd();

        this.transitionVideo.classList.remove('under-icons');
        this.mainContent.style.display     = 'none';
        this.transitionVideo.style.display = 'none';
        this.eduPage.style.display         = 'flex';

        this.fadeInPageContent(this.eduPage);
      } catch (e) {
        console.error('Edu transition error:', e);
        this.handleTransitionError('edu');
      } finally { this.isTransitioning = false; }
    });
  },

  setupReverseTransition(backButton, pageType) {
    backButton.addEventListener('click', async () => {
      if (this.isTransitioning) return;
      this.isTransitioning = true;
      try {
        const targetPage    = pageType === 'contacts' ? this.contactsPage : this.eduPage;
        const reverseVideo   = pageType === 'contacts' ? CONFIG.TRANSITION.CONTACTS_REVERSE : CONFIG.TRANSITION.EDU_REVERSE;

        if (reverseVideo) {
          const video = this.transitionVideo, source = video.querySelector('source');
          video.style.transform = `translateY(${CONFIG.TRANSITION.OFFSET}px)`;
          source.src = reverseVideo;
          video.load();
          video.currentTime = 0;
          if (pageType === 'edu') video.classList.add('under-icons');

          video.style.display = 'block';
          await video.play();

          requestAnimationFrame(() => {
            targetPage.style.display = 'none';
            this.mainContent.style.display = 'block';
            Utils.getElement('bgFreeze').style.display = 'block';
          });

          Object.values(window.iconInstances).forEach(inst => inst.reset());

          if (pageType === 'contacts') {
            gsap.set(Utils.getElement('eyeOffset'), { opacity: 1 });
          }

          const iconDelay = (pageType === 'edu' ? CONFIG.TIMING.EDU_REVERSE_ICON_FADE : 300) / 1000;
          this.fadeIconsIn(iconDelay);

          await this.waitForVideoEnd();

          if (pageType === 'edu') {
            gsap.to(Utils.getElement('eyeOffset'), { opacity: 1, duration: CONFIG.GSAP.EYE_FADE_FAST, ease: 'power2.out' });
          }

          video.classList.remove('under-icons');
          video.style.display = 'none';
        } else {
          targetPage.style.display = 'none';
          this.mainContent.style.display = 'block';
          Utils.getElement('bgFreeze').style.display = 'block';
          Object.values(window.iconInstances).forEach(inst => inst.reset());
          this.fadeIconsIn(0.3);
          gsap.set(Utils.getElement('eyeOffset'), { opacity: 1 });
        }

        setTimeout(() => EyeSystem.blinkOnce(), 100);
      } catch (e) {
        console.error('Reverse transition error:', e);
        this.handleTransitionError(null);
      } finally { this.isTransitioning = false; }
    });
  },

  handleTransitionError(pageType) {
    this.transitionVideo.style.display = 'none';
    if (pageType === 'contacts') {
      this.mainContent.style.display   = 'none';
      this.contactsPage.style.display  = 'flex';
      this.eduPage.style.display       = 'none';
    } else if (pageType === 'edu') {
      this.mainContent.style.display   = 'none';
      this.eduPage.style.display       = 'flex';
      this.contactsPage.style.display  = 'none';
    } else {
      this.contactsPage.style.display  = 'none';
      this.eduPage.style.display       = 'none';
      this.mainContent.style.display   = 'block';
      Utils.getElement('bgFreeze').style.display = 'block';
      gsap.set(Utils.getElement('eyeOffset'), { opacity: 1 });
      Object.values(window.iconInstances).forEach(inst => inst.reset());
      this.fadeIconsIn(0);
    }
  }
};

/* ========================================================================
   EYE SYSTEM
   ======================================================================== */
const EyeSystem = {
  eyeMove: null, eyeOffset: null, blinkLid: null,
  bgVideo: null, bgFreeze: null, ctx: null,
  eyeActive: false, eyeActivationTriggered: false,
  reflectionsMove: null,

  init() {
    this.eyeMove         = Utils.getElement('eyeMove');
    this.eyeOffset       = Utils.getElement('eyeOffset');
    this.blinkLid        = Utils.getElement('blinkLid');
    this.bgVideo         = Utils.getElement('bgVideo');
    this.bgFreeze        = Utils.getElement('bgFreeze');
    this.reflectionsMove = Utils.getElement('reflectionsMove');
    this.ctx             = this.bgFreeze.getContext('2d');
    this.setupVideoListeners();
    this.setupTracking();
    this.setupFallback();
  },

  setupVideoListeners() {
    this.bgVideo.addEventListener('timeupdate', () => {
      if (this.eyeActivationTriggered || this.eyeActive) return;
      if (this.bgVideo.currentTime >= CONFIG.TIMING.EYE_ACTIVATE_TIME) this.activateEye();
    });
    this.bgVideo.addEventListener('ended', () => {
      if (this.eyeActivationTriggered || this.eyeActive) return;
      this.activateEye();
    });
  },

  activateEye() {
    this.eyeActivationTriggered = true;
    this.bgFreeze.width  = this.bgVideo.videoWidth;
    this.bgFreeze.height = this.bgVideo.videoHeight;
    if (this.bgFreeze.width > 0 && this.bgFreeze.height > 0) {
      try {
        this.ctx.drawImage(this.bgVideo, 0, 0, this.bgFreeze.width, this.bgFreeze.height);
        this.bgVideo.style.display  = 'none';
        this.bgFreeze.style.display = 'block';
        gsap.to(this.eyeOffset, { opacity: 1, duration: CONFIG.GSAP.EYE_FADE_ACTIVATE, ease: 'power2.out' });
        this.eyeActive = true;
        setTimeout(() => this.blinkOnce(), 100);
        this.startBlinking();
        Utils.log('‚úÖ Eye activated!');
      } catch (e) { console.error('Failed to draw video to canvas:', e); }
    }
  },

  setupTracking() {
    document.addEventListener('mousemove', (e) => {
      if (this.eyeActive && !DeviceDetector.isTouchDevice) this.updateEyePosition(e.clientX, e.clientY);
    });
    document.addEventListener('touchmove', (e) => {
      if (this.eyeActive && e.touches.length) this.updateEyePosition(e.touches[0].clientX, e.touches[0].clientY);
    }, { passive: true });
    document.addEventListener('touchstart', (e) => {
      if (this.eyeActive && e.touches.length) this.updateEyePosition(e.touches[0].clientX, e.touches[0].clientY);
    }, { passive: true });
  },

  updateEyePosition(cx, cy) {
    const x = (cx / window.innerWidth  - 0.5) * 120;
    const y = (cy / window.innerHeight - 0.5) * 60;
    this.eyeMove.setAttribute('transform', `translate(${x}, ${y})`);
    this.reflectionsMove.setAttribute('transform',
      `translate(${x * CONFIG.EYE.REFLECTION_MOVEMENT}, ${y * CONFIG.EYE.REFLECTION_MOVEMENT})`);
  },

  setupFallback() {
    setTimeout(() => {
      if (!this.eyeActive) {
        console.warn('‚ö†Ô∏è Eye fallback triggered');
        gsap.to(this.eyeOffset, { opacity: 1, duration: CONFIG.GSAP.EYE_FADE_ACTIVATE });
        this.eyeActive = true;
        this.startBlinking();
      }
    }, CONFIG.TIMING.EYE_FALLBACK_TIMEOUT);
  },

  blinkOnce() {
    if (!this.eyeActive) return;
    this.blinkLid.style.animation = `blink ${CONFIG.TIMING.BLINK_SPEED}ms ease-in-out`;
    this.blinkLid.addEventListener('animationend', () => { this.blinkLid.style.animation = ''; }, { once: true });
  },
  
  blink() {
    this.blinkOnce();
    if (Math.random() < CONFIG.EYE.DOUBLE_BLINK_CHANCE)
      setTimeout(() => this.blinkOnce(), CONFIG.TIMING.DOUBLE_BLINK_DELAY);
  },
  
  startBlinking() {
    const loop = () => {
      this.blink();
      setTimeout(loop, CONFIG.TIMING.BLINK_MIN_DELAY + Math.random() * (CONFIG.TIMING.BLINK_MAX_DELAY - CONFIG.TIMING.BLINK_MIN_DELAY));
    };
    loop();
  },

  resetToCenter() {
    if (!this.eyeActive) return Promise.resolve();

    const attr = this.eyeMove.getAttribute('transform') || 'translate(0,0)';
    const m    = attr.match(/translate\(([-\d.]+),\s*([-\d.]+)\)/);
    const sx   = m ? parseFloat(m[1]) : 0;
    const sy   = m ? parseFloat(m[2]) : 0;
    if (sx === 0 && sy === 0) return Promise.resolve();

    const proxy = { x: sx, y: sy };
    return new Promise(resolve => {
      gsap.to(proxy, {
        x: 0, y: 0,
        duration: CONFIG.GSAP.EYE_RESET_DURATION,
        ease: 'power3.out',
        onUpdate: () => {
          this.eyeMove.setAttribute('transform', `translate(${proxy.x}, ${proxy.y})`);
          this.reflectionsMove.setAttribute('transform',
            `translate(${proxy.x * CONFIG.EYE.REFLECTION_MOVEMENT}, ${proxy.y * CONFIG.EYE.REFLECTION_MOVEMENT})`);
        },
        onComplete: resolve
      });
    });
  }
};

/* ========================================================================
   INIT
   ======================================================================== */
document.addEventListener('DOMContentLoaded', () => {
  DeviceDetector.init();
  Preloader.init();
  IconPositioner.init();

  // Create sprite sheet icons with SIMPLIFIED SPEEDS
  window.iconInstances = {
    art: new SpriteSheetIcon(
      Utils.getElement('icon-art'),
      48,      // frameCount
      180,     // frameWidth (scaled to 180px base)
      169,     // frameHeight (scaled proportionally)
      8640,    // spriteWidth (scaled proportionally)
      18,      // holdFrame (adjust to your preference)
      { forwardSpeed: 0.1, reverseSpeed: 0.3 }
    ),
    
    contacts: new SpriteSheetIcon(
      Utils.getElement('icon-contacts'),
      30,      // frameCount
      180,     // frameWidth (scaled to 180px base)
      203,     // frameHeight (scaled proportionally)
      5400,    // spriteWidth (scaled proportionally)
      17,      // holdFrame (adjust to your preference)
      { forwardSpeed: 0.03, reverseSpeed: 0.3 }
    ),
    
    edu: new SpriteSheetIcon(
      Utils.getElement('icon-edu'),
      50,      // frameCount
      180,     // frameWidth (scaled to 180px base)
      126,     // frameHeight (scaled proportionally)
      9000,    // spriteWidth (scaled proportionally)
      23,      // holdFrame (adjust to your preference)
      { forwardSpeed: 0.01, reverseSpeed: 0.3 }
    ),
    
    work: new SpriteSheetIcon(
      Utils.getElement('icon-work'),
      29,      // frameCount
      180,     // frameWidth (scaled to 180px base)
      226,     // frameHeight (scaled proportionally)
      5220,    // spriteWidth (scaled proportionally)
      null,    // no holdFrame - loops continuously
      { loopSpeed: 0.2, reverseSpeed: 0.3 }
    )
  };

  TransitionManager.init();
  EyeSystem.init();
  Utils.log('‚úÖ Application initialized with sprite sheets!');
});
</script>
</body>
</html>
